{% extends 'base/base.html' %}
{% load static %}
{% block title %}Suplier_List - Point of Sale System{% endblock %}
{% include 'base/style.html' %}
{% block content %}
<style>
    @keyframes blink {
  0% { opacity: 1; color: yellow; letter-spacing: 5px}
  50% { opacity: 0; letter-spacing: 2.5px }
  100% { opacity: 1; color: yellow; letter-spacing: 5px;}
}

.blinking {
  animation: blink 1s infinite;
}
</style>
<div class="card">
  <div class="card-body bg-danger">
    <h5 class="card-title blinking">Development in Progress</h5>
    <p class="card-text">This feature is currently under development.</p>
    <p class="card-text">Please check back later for updates.</p>
  </div>
</div>

<div class="row">
    <div class="col-lg-4 mx-auto">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><h4>Payment Method</h4>Mpesa vs. Cash Amounts</h3>
            </div>
            <div class="card-body">
                <canvas id="mpesa-cash-chart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4 mx-auto">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Daily Sales</h3>
            </div>
            <div class="card-body">
                <canvas id="daily-sales-chart"></canvas>
            </div>
        </div>
    </div>
    <style>
    hr {
        background-color: green; /* Set the background color */
        height: 2px; /* Set the height of the hr */
        border: none; /* Remove the default border */
    }
</style>
    <hr>
    <div class="row">
    <div class="col-lg-4 mx-auto">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Most Bought Products</h3>
            </div>
            <div class="card-body">
                <canvas id="most-bought-products-chart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4 mx-auto">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Stock Usage</h3>
            </div>
            <div class="card-body">
                <canvas id="stock-usage-chart"></canvas>
            </div>
        </div>
    </div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Make an AJAX request to fetch the Mpesa and Cash values from the database
        $.ajax({
            url: "{% url 'reports:fetch-data-from-database' %}",
            method: "GET",
            success: function(data) {
                // Parse the response data and extract the Mpesa and Cash values
                const mpesaValue = data.mpesa;
                const cashValue = data.cash;
                var Total = mpesaValue + cashValue;
                // Create the chart using the retrieved values
                var mpesaCashChart = new Chart(document.getElementById("mpesa-cash-chart"), {
                    type: "doughnut",
                    data: {
                    labels: ["Mpesa (Ksh " + mpesaValue + ")", "Cash (Ksh " + cashValue + ")", "Total (Ksh/= "+ Total +")"],
                    datasets: [{
                        data: [mpesaValue, cashValue, 0],
                        backgroundColor: ["green", "silver", "blue"]
                    }]
                }

                });
            },
            error: function() {
                console.log("Error fetching Mpesa and Cash data from the database.");
            }
        });

        // Make an AJAX request to fetch the sales data from the database
$.ajax({
    url: "{% url 'reports:fetch-data-from-database' %}",
    method: "GET",
    success: function(data) {
        const currentDate = new Date();  // Get the current date
        const dateRange = [];  // Array to store the date range
        for (let i = 7; i >= 0; i--) {
            const date = new Date(currentDate);
            date.setDate(currentDate.getDate() - i);
            dateRange.push(date);
        }
        
        // Extract the dates and counts from the response data
        const dates = data.dates.map(date => {
            const formattedDate = new Date(date).toLocaleDateString('en', {
                weekday: 'short',
                day: 'numeric',
                month: 'numeric',
                year: 'numeric'
            });
            const [weekday, day] = formattedDate.split(' ');
            return `${weekday} ${day}`;
        });
        const counts = data.counts;

        // Format the date range for the label
        const formattedDateRange = `${dates[0]} - ${dates[dates.length - 1]}`;

        // Daily Sales Chart
        var dailySalesChart = new Chart(document.getElementById("daily-sales-chart"), {
            type: "bar",
            data: {
                labels: dates,
                datasets: [{
                    label: `Sales for (${formattedDateRange})`,
                    data: counts,
                    backgroundColor: "#4caf50"
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    },
    error: function() {
        console.log("Error fetching sales data from the database.");
    }
});


        // Most Bought Products Chart
        var mostBoughtProductsChart = new Chart(document.getElementById("most-bought-products-chart"), {
            type: "bar",
            data: {
                labels: ["Product A", "Product B", "Product C", "Product D"],
                datasets: [{
                    label: "Quantity",
                    data: [50, 80, 120, 70],
                    backgroundColor: "#ff9800"
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom' // Set the legend position to bottom
                    }
                }
            }
        });

        // Stock Usage Chart
        var stockUsageChart = new Chart(document.getElementById("stock-usage-chart"), {
            type: "pie",
            data: {
                labels: ["Product X", "Product Y", "Product Z"],
                datasets: [{
                    data: [30, 40, 50],
                    backgroundColor: ["#ff5722", "#03a9f4", "#e91e63"]
                }]
            }
        });
    });
</script>
{% endblock %}
